{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "ResourceGroupLocation": {
            "type": "string",
            "metadata": {
                "description": "Deployment region"
            }
        },
        "ResourceGroup_Name": {
            "type": "string",
            "metadata": {
                "description": "Deployment region"
            }
        },
        "vmName": {
            "type": "string",
            "metadata": {
                "description": "VM Name"
            }
        },
        "vmSize": {
            "type": "string",
            "metadata": {
                "description": "VM Size"
            },
            "defaultValue": "Standard_GS5",
            "allowedValues": [
                "Standard_GS5",
                "Standard_M64s",
                "Standard_M64ms",
                "Standard_M128s",
                "Standard_M128ms",
                "Standard_E64s_v3"
                
            ]
        },
        "deployToExistingVnet": {
            "type": "string",
            "metadata": {
                "description": "deploy to existing Vnet"
            },
            "defaultValue": "false"
        },
        "networkName": {
            "type": "string",
            "metadata": {
                "description": "The Hana vNet"
            },
            "defaultValue": ""
        },
        "addressPrefixes": {
            "type": "string",
            "metadata": {
                "description": "The Hana vNET prefix"
            },
            "defaultValue": ""
        },
        "subnetName": {
            "type": "string",
            "metadata": {
                "description": "The Hana subnet name"
            },
            "defaultValue": ""
        },
        "subnetPrefix": {
            "type": "string",
            "metadata": {
                "description": "The data subnet"
            },
            "defaultValue": ""
        },
        "customUri": {
            "type": "string",
            "metadata": {
                "description": "Uri for Custom Script Extension"
            }
        },
        "baseUri": {
            "type": "string",
            "metadata": {
                "description": "Base deployment uri"
            }
        },
        "DscConfigName": {
            "type": "string",
            "metadata": {
                "description": "Name of AzureAutomation Config"
            }
        },
        "CompJobGuid": {
            "type": "string",
            "metadata": {
                "description": "Guid for the automation complication Job"
            }
        }
        
    },
    "variables": {
        "vmName": "[toLower(parameters('vmName'))]",
        "network": "[concat(parameters('baseUri'), '\\Resources\\network.json')]",
        "automation": "[concat(parameters('baseUri'), '\\Resources\\automation.json')]",
        "gs5Uri": "[concat(parameters('baseUri'), '\\Vms\\gs5.json')]",
        "m64sUri": "[concat(parameters('baseUri'), '\\Vms\\m64s.json')]",
        "m64msUri": "[concat(parameters('baseUri'), '\\Vms\\m64ms.json')]",
        "m128sUri": "[concat(parameters('baseUri'), '\\Vms\\m128s.json')]",
        "m128msUri": "[concat(parameters('baseUri'), '\\Vms\\m128ms.json')]",
        "e64s_v3Uri": "[concat(parameters('baseUri'), '\\Vms\\e64s_v3.json')]",
        "configname": "[concat(parameters('DscConfigName'), '.sap-hana')]"
    },
    "resources": [
        {
            "apiVersion": "2016-09-01",
            "name": "AutomationTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('automation')]"
                },
                "parameters": {
                    "vmName": {
                        "value": "[variables('vmName')]"
                    },
                    "CompJobGuid":{
                        "value": "[parameters('CompJobGuid')]"
                    },
                    "AutomationLocation":{
                        "Value": "eastus2"
                    },
                    "baseUri": {
                        "Value": "[parameters('baseUri')]"
                    },
                    "ConfigUri": {
                        "Value": "[concat(parameters('baseUri'), '\\DSC\\', parameters('DscConfigName'), '.ps1')]"
                    },
                    "vmSize": {
                        "Value": "[parameters('vmSize')]"
                    }
                    
                }
            }
               
        },
        {
            "apiVersion": "2016-09-01",
            "name": "NetworkTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('network')]"
                },
                "parameters": {
                    "deployToExistingVnet": {
                        "value": "[parameters('deploytoexistingvnet')]"
                                       },
                  "networkName": {
                    "value": "[parameters('networkName')]"                    
                  },
                  "addressPrefixes": {
                    "value": "[parameters('addressPrefixes')]"
                      
                  },
                  "subnetName": {
                    "value": "[parameters('subnetName')]"
                      
                  },
                  "subnetPrefix": {
                    "value": "[parameters('subnetPrefix')]"
                      
                  }                   
                }
            }
               
        },
        {
            "condition": "[equals(parameters('vmSize'), 'Standard_GS5')]",
            "apiVersion": "2016-09-01",
            "name": "Gs5LinkedTemplate",
            "type": "Microsoft.Resources/deployments",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', 'NetworkTemplate')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('gs5Uri')]"
                },
                "parameters": {
                    "vmName": {
                        "value": "[variables('vmName')]"
                    },
                    "customUri": {
                        "value": "[parameters('customUri')]"
                    },
                    "networkName": {
                        "value": "[parameters('networkName')]"
                    },
                    "addressPrefixes": {
                        "value": "[parameters('addressPrefixes')]"
                    },
                    "subnetName": {
                        "value": "[parameters('subnetName')]"
                    },
                    "subnetPrefix": {
                        "value": "[parameters('subnetPrefix')]"
                    },
                    "AzureDscUri": {
                        "value": "[reference('AutomationTemplate').outputs.registrationUrl.value]"
                    },
                    "AzureDscKey": {
                        "value": "[reference('AutomationTemplate').outputs.keys.value]"
                    },
                    "DscConfigName": {
                        "value": "[variables('configname')]"
                    }
                }
            }
        },
        {
            "condition": "[equals(parameters('vmSize'), 'Standard_M64s')]",
            "apiVersion": "2016-09-01",
            "name": "M64sLinkedTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('m64sUri')]"
                },
                "parameters": {
                    "vmName": {
                        "value": "[variables('vmName')]"
                    },
                    "customUri": {
                        "value": "[parameters('customUri')]"
                    },
                    "networkName": {
                        "value": "[parameters('networkName')]"
                    },
                    "addressPrefixes": {
                        "value": "[parameters('addressPrefixes')]"
                    },
                    "subnetName": {
                        "value": "[parameters('subnetName')]"
                    },
                    "subnetPrefix": {
                        "value": "[parameters('subnetPrefix')]"
                    },
                    "AzureDscUri": {
                        "value": "[reference('AutomationTemplate').outputs.registrationUrl.value]"
                    },
                    "AzureDscKey": {
                        "value": "[reference('AutomationTemplate').outputs.keys.value]"
                    },
                    "DscConfigName": {
                        "value": "[variables('configname')]"
                    }
                }
            }
        },
        {
            "condition": "[equals(parameters('vmSize'), 'Standard_M64ms')]",
            "apiVersion": "2016-09-01",
            "name": "M64msLinkedTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('m64msUri')]"
                },
                "parameters": {
                    "vmName": {
                        "value": "[variables('vmName')]"
                    },
                    "customUri": {
                        "value": "[parameters('customUri')]"
                    },
                    "networkName": {
                        "value": "[parameters('networkName')]"
                    },
                    "addressPrefixes": {
                        "value": "[parameters('addressPrefixes')]"
                    },
                    "subnetName": {
                        "value": "[parameters('subnetName')]"
                    },
                    "subnetPrefix": {
                        "value": "[parameters('subnetPrefix')]"
                    },
                    "AzureDscUri": {
                        "value": "[reference('AutomationTemplate').outputs.registrationUrl.value]"
                    },
                    "AzureDscKey": {
                        "value": "[reference('AutomationTemplate').outputs.keys.value]"
                    },
                    "DscConfigName": {
                        "value": "[variables('configname')]"
                    }
                }
            }
        },
        {
            "condition": "[equals(parameters('vmSize'), 'Standard_M128s')]",
            "apiVersion": "2016-09-01",
            "name": "M128sLinkedTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('m128sUri')]"
                },
                "parameters": {
                    "vmName": {
                        "value": "[variables('vmName')]"
                    },

                    "customUri": {
                        "value": "[parameters('customUri')]"
                    },
                    "networkName": {
                        "value": "[parameters('networkName')]"
                    },
                    "addressPrefixes": {
                        "value": "[parameters('addressPrefixes')]"
                    },
                    "subnetName": {
                        "value": "[parameters('subnetName')]"
                    },
                    "subnetPrefix": {
                        "value": "[parameters('subnetPrefix')]"
                    },
                    "AzureDscUri": {
                        "value": "[reference('AutomationTemplate').outputs.registrationUrl.value]"
                    },
                    "AzureDscKey": {
                        "value": "[reference('AutomationTemplate').outputs.keys.value]"
                    },
                    "DscConfigName": {
                        "value": "[variables('configname')]"
                    }
                }
            }
        },
        {
            "condition": "[equals(parameters('vmSize'), 'Standard_M128ms')]",
            "apiVersion": "2016-09-01",
            "name": "M128msLinkedTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('m128msUri')]"
                },
                "parameters": {
                    "vmName": {
                        "value": "[variables('vmName')]"
                    },
                    "customUri": {
                        "value": "[parameters('customUri')]"
                    },
                    "networkName": {
                        "value": "[parameters('networkName')]"
                    },
                    "addressPrefixes": {
                        "value": "[parameters('addressPrefixes')]"
                    },
                    "subnetName": {
                        "value": "[parameters('subnetName')]"
                    },
                    "subnetPrefix": {
                        "value": "[parameters('subnetPrefix')]"
                    },
                    "AzureDscUri": {
                        "value": "[reference('AutomationTemplate').outputs.registrationUrl.value]"
                    },
                    "AzureDscKey": {
                        "value": "[reference('AutomationTemplate').outputs.keys.value]"
                    },
                    "DscConfigName": {
                        "value": "[variables('configname')]"
                    }
                }
            }
        },
        {
            "condition": "[equals(parameters('vmSize'), 'Standard_E64s_v3')]",
            "apiVersion": "2016-09-01",
            "name": "E64sV3LinkedTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('e64s_v3Uri')]"
                },
                "parameters": {
                    "vmName": {
                        "value": "[variables('vmName')]"
                    },
                    "customUri": {
                        "value": "[parameters('customUri')]"
                    },
                    "networkName": {
                        "value": "[parameters('networkName')]"
                    },
                    "addressPrefixes": {
                        "value": "[parameters('addressPrefixes')]"
                    },
                    "subnetName": {
                        "value": "[parameters('subnetName')]"
                    },
                    "subnetPrefix": {
                        "value": "[parameters('subnetPrefix')]"
                    },
                    "AzureDscUri": {
                        "value": "[reference('AutomationTemplate').outputs.registrationUrl.value]"
                    },
                    "AzureDscKey": {
                        "value": "[reference('AutomationTemplate').outputs.keys.value]"
                    },
                    "DscConfigName": {
                        "value": "[variables('configname')]"
                    }
                }
            }
        }
        
    ],
    "outputs": {}
}